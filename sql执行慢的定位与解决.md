# sql执行慢的定位与解决

![](/home/rapheal-wu/learning/MysqlPractice/MySqlPractice/SQL_SLOW.JPG)

我们来解释下这张图。

首先在s1部分，需要观察服务器的状态是否存在周期性的波动，如果存在周期性的波动，有可能是周期性节点的原因，比如双十一，促销等，这样就可以通过A1这一步解决，也就是加缓存，或者更改缓存失效策略。

如果缓存策略没有解决，或者不是周期性波动的原因，接下来进入S2这一步，需要开启慢查询。慢查询可以帮我们定位执行慢的ＳＱＬ语句，通过设置long_query_time参数定义“慢”的阈值。如果ＳＱＬ执行时间超过了long_query_time,　则认为是慢查询。

在Ｓ３这一步，我们获知执行慢的ＳＱＬ语句，这样就可以有针对性地使用ＥＸＰＬＡＩＮ查看对应ＳＱＬ语句的执行计划，或者使用ＳＨＯＷ　ＰＲＯＦＩＬＥ查看ＳＱＬ中每一个步骤的时间成本。这样就可以了解ＳＱＬ查询慢是由于执行时间长，还是等待时间长。

如果是等待时间长，我们进入Ａ２步骤。在这一步骤中，我们可以调优服务器参数，比如适当增加数据库缓冲池等，如果是ＳＱＬ执行时间长，就进入Ａ３步骤，这一步我们要考虑是索引设计问题还是查询关联的数据表过多？还是因为数据表的字段设计问题导致了这一现象。然后在这些维度上进行对应的调整。

如果Ａ２和Ａ３都不能解决问题，我们需要考虑数据库自身的ＳＱＬ查询性能是否已经达到了瓶颈，进入Ａ４阶段，需要考虑增加服务器，采用读写分离的架构，或者考虑对数据库分库分表，比如垂直分库、垂直分表和水平分表等。

以上就是数据库调优的流程思路。当我们发现执行ＳＱＬ是存在不规则延迟或者卡顿的时候，就可以采用分析工具帮我们定位有问题的ｓｑｌ，这三种分析工具你可以理解是ＳＱＬ调优的三个步骤：慢查询、ＥＸＰＬＡＩＮ和ＳＨＯＷ　ＰＲＯＦＩＬＥ。

## 使用慢查询定位执行慢的ＳＱＬ

慢查询可以帮我们找到执行慢的ＳＱＬ，使用前有先看下慢查询是否已经开启，使用下面这条命令即可；

![](/home/rapheal-wu/learning/MysqlPractice/MySqlPractice/深度截图_选择区域_20200414214842.png)

可以看到slow_query_log=OFF，也就是说慢查询日志此时是关上的。我们可以把慢查询日志打开，注意设置变量值的时候需要使用global，否则会报错：

```mysql
mysql> set global slow_query_log='ON';
```

然后我们再来查看下慢查询日志是否开启，以及慢查询日志文件的位置：

![](/home/rapheal-wu/learning/MysqlPractice/MySqlPractice/深度截图_选择区域_20200414215625.png)

你能看到此时慢查询分析已经开启，同时文件保存在/var/lib/mysql/raphealwu-TM1707-slow.log中

接下来我们查看慢查询的时间阈值设置，使用如下命令：

![](/home/rapheal-wu/learning/MysqlPractice/MySqlPractice/深度截图_选择区域_20200414220304.png)

这时如果我们想把事假缩短，比如设置３秒，可以这样设置：

![](/home/rapheal-wu/learning/MysqlPractice/MySqlPractice/深度截图_选择区域_20200414221156.png)

我们可以使用ＭＹＳＱＬ自带的mysqlsumpslow工具查询慢日志。这个工具是个ｐｅｒｌ，所以你需要先安装ｐｅｒl。

mysqldumpslow命令的具体参数如下：

- -s: 采用order排序的方式，排序方式有以下几种，分别是c（访问次数）、t(查询时间)、l（锁定时间）、r（返回记录）、ac（平均查询时间）、al（平均锁定时间）和at（平均查询时间）。其中at为默认默认排序方式。
- -t : 返回前Ｎ条数据。
- -g: 后面可以是正则表达式，对大小写不敏感。

```perl
perl  mysqldumpslow -s t -t 2 "/var/lib/mysql/raphealwu-TM1707-slow.log"
```

